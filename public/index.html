<!DOCTYPE html>
<html>
  <head>
    <title>Simple Chat by Josh Gough</title>
    <link href='http://fonts.googleapis.com/css?family=Iceland' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>    
    <link href='http://fonts.googleapis.com/css?family=Diplomata' rel='stylesheet' type='text/css'>  
    <script src='https://code.jquery.com/jquery-2.1.0.min.js'></script>
    <script>
var msgs = [];

function msgPost(msg, callback) {
  //var json = JSON.stringify(msg);
  $.post("msgs", msg, function(response) {
      if (callback) {
        callback(response);
      }
  });
}

function msgPostClick() {
  var text = $('#text').val();
  var name = $('#name').val();
  if (!text) {
    alert('Please type a message in the textbox before sending!');
  } else if (!name) {
    alert('Please type your name in the textbox before sending!');
  } else {
    var msg = {
      text: text,
      name: name
    };
    msgPost(msg, function(response) {
      if (response == "OK") {
        $('#text').val('');
      }
    });
  }
}

var refreshSince = '';

function msgsGet(since, callback) {
  $.get("msgs/" + since, function(newMsgs) {
    newMsgs.msgs.forEach(function(msg) {
      msgs.push(msg);
    });
    refreshSince = newMsgs.refreshSince;
    if (callback) {
      callback(newMsgs, msgs);
    }
  });
}

function getMyUserName() {
  return $('#name').val();
}

function onNewMsgs(newMsgs, allMsgs) {
  /*
    <article data-self='true' data-user='Josh'>
      <header>You:</header>
      <p>
        Hey there!
      </p>
      <time datetime='2014-04-06T02:14:20.718Z'>10:21 PM</time>
    </article>
  */
  var msgsPublic = $('#msgsPublic');
  newMsgs.msgs.forEach(function(msg) {
    var isMyMessage = msg.name == getMyUserName();
    var timestamp = new Date(msg.timestamp);
    var time = timestamp.toLocaleTimeString("en-US", 
      {hour: '2-digit', minute:'2-digit'});
    var newMessage = 
      "<article style='display:none'"
        + " data-self='" + isMyMessage + "'"
        + " data-user='" + msg.name + "'>\n"
        + "\t<header>" + msg.name + ":</header>\n"
        + "\t<p>" + msg.text + "</p>\n"
        + "\t<time datetime='" + msg.timestamp + "'>" + time + "</time>\n"
      + "</article>";
    var newMessageElement = $(newMessage);
    msgsPublic.prepend(newMessageElement);
    newMessageElement.fadeIn("slow");
  });
}

function msgsGetRefreshClick() {
  var since = $('#since').val();
  if (!since) {
    since = refreshSince;
  }
  msgsGet(since, onNewMsgs);
}

var autoRefreshTimerId = null;

var autoRefreshListenerFunctions = [];

function autoRefreshListenerAdd(listener) {
  autoRefreshListenerFunctions.push(listener);
}

function autoRefreshStart() {
  autoRefreshStop();
  function autoRefreshComplete(newMsgs, allMsgs) {
    if (autoRefreshListenerFunctions.length > 0) {
      autoRefreshListenerFunctions.forEach(function(func) {
        func(newMsgs, allMsgs);
      });
    }
  }
  function invokeMsgsGet() {
    msgsGet(refreshSince, autoRefreshComplete);
  }
  autoRefreshTimerId = window.setInterval(invokeMsgsGet, 2500);
}

function autoRefreshUIStart() {
  autoRefreshListenerAdd(onNewMsgs);
  autoRefreshStart();  
}

function autoRefreshStop() {
  if (autoRefreshTimerId != null) {
    window.clearInterval(autoRefreshTimerId);
    autoRefreshTimerId = null;
  }
}
    </script>
    <style>
#msgsPublic {
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAIAAAACDbGyAAAALElEQVQImWP0srRkgIETV64wIXMsdHSYkDkMDAxMyBwGBgZGIV5eOIeBgQEAR7QM8V3ILEcAAAAASUVORK5CYII=);
  overflow: hidden; 
}

#msgsPublic article {
  width: 85%;
  font-family: 'Iceland', cursive;
  border: .1em solid seagreen;
  /*box-shadow: 5px 5px 5px #888888;*/
  margin-bottom: 1em;
  border-radius: .5em;
  float:left;
  background-color:greenyellow;
}

#msgsPublic header {
  background-color: darkgreen;
  color: white;
  font-size: 125%;
  padding: 6px;
  border-top-left-radius: .3em;
  border-top-right-radius: .3em;
}

#msgsPublic p {
  padding-left: 8px;
}

#msgsPublic time {
  color: #333333;
  padding-left: 6px;
  font-weight: bold;
  font-size: 75%;
  float: left;
}

#msgsPublic article[data-self='true'] {
  float:right;
  background-color:lightblue;
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}

#msgsPublic article[data-self='true'] header {
  border-top-right-radius: 0em;
}

#msgsPublic article:not([data-self='true']) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}

#msgsPublic article:not([data-self='true']) header {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}

#msgsPublic article[data-user='jogo'][data-self='false'] {
  background: orange;
}

#msgsPublic article[data-user='jogo'][data-self='false'] p {
  font-size: 150%;
  color: purple;
}

/*
#msgsPublic article[data-user='sally'] p {
  font-family: 'Diplomata', cursive;  
}
*/
    </style>
  </head>
  <body>
    <section id='form'>
      Your Name: <input type='text' id='name' />
      <br />
      Message: <input type='text' id='text' /> <button onclick='msgPostClick()'>Send</button>
      <hr />
      Show messages since: <input type='text' id='since' />
      <button onclick='msgsGetRefreshClick()'>Refresh</button>
      <button onclick='autoRefreshUIStart()'>Start Auto-Refresh</button>
      <button onclick='autoRefreshStop()'>Stop Auto-Refresh</button>
    </section>
    <section id="msgsPublic">
      <article data-self='true' data-user='Josh'>
        <header>You:</header>
        <p>
          Hey there!
        </p>
        <time datetime='2014-04-06T02:14:20.718Z'>10:21 PM</time>
      </article>
      <article data-user='bob'>
        <header>Bob:</header>
        <p>What's going on Josh?</p>
        <time datetime='2014-04-06T02:14:20.718Z'>10:20 PM</time>
      </article>      
      <article data-user='sally'>
        <header>Sally:</header>
        <p>Hey Bob and Josh :-D</p>
        <time datetime='2014-04-06T02:14:20.718Z'>10:20 PM</time>
      </article>          
    </section>
    <br clear="all" />
    <h1>Build your own chat room</h1>

    <p>
    Today you're going to learn how to create your own web chat room
    that you can add into your own web page and chat with visitors
    to your site.
    </p>

    <p>By taking this quest, you'll learn all about the fundamentals
      of how the web works, including how to GET data from web servers and POST data to web servers. That might sound simple to you. Well, it is pretty simple once you know about a few tools that can help you make it even simpler!</p>

    <p>Before we start programming the chat room, let's look at the finished product in action so you can understand what you'll build and what it will be like to use once you finish!</p>

    <aside>
      <p>If you're completely new to the web and to programming in general, then here is an exercise you can do on paper understand what we're doing.</p>
      <h2>Supplies:</h2>
      <ul>
        <li>Several sheets of paper and pen or pencil</li>
        <li>Two other friends. One will do, but it's better with two!</li>
      </ul>
      <h2>Steps:</h2>
      <ul>
          <li>Starting on one sheet of paper, write a heading at the top: <strong>Messages:</strong></li>
          <li>Decide who will be the first message writer.</li>
          <li>For the other two, close your eyes or stand somewhere where you cannot see what your friend is writing.</li>
          <li>First message writer: write down a short message on the line after the <strong>Messages:</strong> heading, then hand the paper and pen to one of your other friends.</li>
          <li>Take turns writing and passing the sheet to each other.</li>
      </ul>
      <h2>Questions:</h2>
      <ul>
        <li>Assuming you are a group of three, how would you communicate with the paper if two of you had to stay in different rooms, and only one of you could move from one room to the other at a time?</li>
        <li>What if you had ten other friends who you wanted to see your messages? How long would it take for each of them to see it using this paper process?</li>
        <li>What if you had a message that you wanted the whole world to see? How long do you think it would take if you had to hand deliver it to each person?</li>
        <li>What if you could send it in the mail?</li>
        <li>What else could you do to get it to more people faster?</li>
      </ul>
      <h1></h1>
    </p>



      <p>First, get a sheet of paper and a pencil or find a whiteboard and a marker.

    </aside>

  </body>
</html>