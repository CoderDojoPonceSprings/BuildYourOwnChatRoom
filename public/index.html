<!DOCTYPE html>
<html>
  <head>
    <title>Simple Chat by Josh Gough</title>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">    
    <link href='http://fonts.googleapis.com/css?family=Iceland' rel='stylesheet' 
    <link id='style-none' rel='stylesheet' href='style.none.css' disabled />    
    <link id='style-dojodroid' rel='stylesheet' href='style.dojodroid.css' />
    <link id='style-jogoshugh' rel='stylesheet' href='style.jogoshugh.css' disabled />    
    <script src='https://code.jquery.com/jquery-2.1.0.min.js'></script>
    <script>
var msgsDatabase = [];

function msgsSetToSampleData() {
  msgsDatabase.length = 0;

  var newMsgs = new Object();
  newMsgs.refreshSince = "";
  newMsgs.msgs = []; // Empty array

  newMsgs.msgs.push({
    name:'JogoShugh',
    text:'Hello world!',
    timestamp: new Date()
  });
  
  newMsgs.msgs.push({
    name:'DojoCoder',
    text:'I\'m ready to code!',
    timestamp: new Date()
  });
  
  newMsgs.msgs.push({
    name:'Guru',
    text:'I can code circles around JogoShugh!',
    timestamp: new Date()
  });

  msgsGetCompleted(newMsgs, msgsDatabase);
}

function getMyUserName() {
  return $('#name').val();
}

function msgPost(msg, callback) {
  $.post("msgs", msg, msgPostCompleted);
}

function msgPostCompleted(response) {
  if (response == "OK") {
    $('#text').val('');
  } else {
    console.log('Something went wrong trying to post new message:');
    console.log(response);
  }
}

function msgPostClick() {
  var text = $('#text').val();
  var name = $('#name').val();
  if (!text) {
    alert('Please type a message in the textbox before sending!');
  } else if (!name) {
    alert('Please type your name in the textbox before sending!');
  } else {
    var msg = {
      text: text,
      name: name
    };
    msgPost(msg);
  }
}

var refreshSince = '';

function msgsGet(since) {
  if (!since) {
    since = "";
  }
  $.get("msgs/" + since, function(newMsgs) {
    newMsgs.msgs.forEach(function(msg) {
      msgsDatabase.push(msg);
    });
    msgsGetCompleted(newMsgs, msgsDatabase);
  });
}

function setDefaultUIMsgsGetCompletedFunction() {
  msgsGetCompleted = function(newMsgs, allMsgs) {
    refreshSince = newMsgs.refreshSince;
    var msgsPublic = $('#msgsPublic');
    newMsgs.msgs.forEach(function(msg) {
      /* This is the HTML structure we need to created for each message:
        <article data-self='true' data-user='DojoCoder'>
          <header>DojoCoder:</header>
          <p>
            I'm ready to code!
          </p>
          <time datetime='2014-04-06T02:14:20.718Z'>10:21 PM</time>
        </article>
      */      
      var isMyMessage = msg.name == getMyUserName();
      var timestamp = new Date(msg.timestamp);
      var time = timestamp.toLocaleTimeString('en-US', 
        {hour: '2-digit', minute:'2-digit'});
      var newMessage = 
        "<article style='display:none'"
          + " data-self='" + isMyMessage + "'"
          + " data-user='" + msg.name + "'>\n"
          + "\t<header>" + msg.name + ":</header>\n"
          + "\t<p>" + msg.text + "</p>\n"
          + "\t<time datetime='" + msg.timestamp + "'>" + time + "</time>\n"
        + "</article>";
      var newMessageElement = $(newMessage);
      msgsPublic.prepend(newMessageElement);
      newMessageElement.fadeIn("slow");
    });
  };
}

function setDefaultConsoleMsgsGetCompletedFunction() {
  msgsGetCompleted = function(newMsgs, allMsgs) {
    refreshSince = newMsgs.refreshSince;
    console.log('New messages count: ' + newMsgs.msgs.length);
    newMsgs.msgs.forEach(function(msg) {
      var isMyMessage = msg.name == getMyUserName();
      var json = JSON.stringify(msg);
      if (isMyMessage) {
        console.log("You said:");
      }
      else {
        console.log(msg.name + " said:");
      }
      console.log(json);
    });
    console.log('Most recently seen message date: ' + newMsgs.refreshSince);
  };
}

function msgsGetNewOnce() {
  var since = $('#since').val();
  if (!since) {
    since = refreshSince;
  }
  msgsGet(since);
}

var repeatedlyGetNewMsgsInteveralId = null;

function msgsGetNewRepeatedly() {
  stopRepeatedlyGettingNewMsgs(); // In case we already are
  function callMsgsGet() {
    msgsGet(refreshSince);
  }
  repeatedlyGetNewMsgsInteveralId = setInterval(callMsgsGet, 2500);
}

function stopRepeatedlyGettingNewMsgs() {
  if (repeatedlyGetNewMsgsInteveralId != null) {
    clearInterval(repeatedlyGetNewMsgsInteveralId);
    repeatedlyGetNewMsgsInteveralId = null;
  }
}

function allowGetMsgsButton() {
  $("#pauseGettingMsgsButton").attr("disabled", "disabled"); 
  $("#getMsgsButton").removeAttr("disabled");
}

function allowPauseGetttingMsgsButton() {
  $("#pauseGettingMsgsButton").removeAttr("disabled");
  $("#getMsgsButton").attr("disabled", "disabled");
}

function styleApply() {
  var selectedStyle = $('#styles').val();
  var sheet = $('#style-' + selectedStyle);
  sheet.removeAttr('disabled');
  $('link[rel=stylesheet]').each(function() {    
    // The function is "applied" in the context of each matching
    // element. So, the 'this' object points to the element.
    if (this.id != 'style-' + selectedStyle) $(this).attr('disabled', 'disabled');
  });
}

$(function() {
  // Configure some defaults
  setDefaultUIMsgsGetCompletedFunction();
  msgsSetToSampleData();
  msgsGetNewRepeatedly();
});
    </script>
  </head>
  <body>
    Style: 
    <select id='styles'>
      <option value='none'>None</option>       
      <option value='dojodroid' selected>Dojo Droid</option>
      <option value='jogoshugh'>JogoShugh</option>
    </select>
    <button onclick='styleApply()'>Apply</button>
    <section id='form'>
      Your Name: <input type='text' id='name' />
      <br />
      Message: <input type='text' id='text' /> <button onclick='msgPostClick()'>Send</button>
      <hr />
      <button
        id='pauseGettingMsgsButton'
        onclick='stopRepeatedlyGettingNewMsgs(); allowGetMsgsButton();'><i class="fa fa-pause"></i>&nbsp;Pause</button>      
      <button
        id='getMsgsButton'
        onclick='msgsGetNewRepeatedly(); allowPauseGetttingMsgsButton();'
        disabled><i class="fa fa-play"></i>&nbsp;Receive Messages</button>
    </section>
    <section id="msgsPublic">
      <article data-self='true' data-user='Josh'>
        <header>You:</header>
        <p>
          Hey there!
        </p>
        <time datetime='2014-04-06T02:14:20.718Z'>10:21 PM</time>
      </article>
      <article data-user='bob'>
        <header>Bob:</header>
        <p>What's going on Josh?</p>
        <time datetime='2014-04-06T02:14:20.718Z'>10:20 PM</time>
      </article>      
      <article data-user='sally'>
        <header>Sally:</header>
        <p>Hey Bob and Josh :-D</p>
        <time datetime='2014-04-06T02:14:20.718Z'>10:20 PM</time>
      </article>          
    </section>
    <br clear="all" />
    <h1>Build your own chat room</h1>

    <p>
    Today you're going to learn how to create your own web chat room
    that you can add into your own web page and chat with visitors
    to your site.
    </p>

    <p>By taking this quest, you'll learn all about the fundamentals
      of how the web works, including how to GET data from web servers and POST data to web servers. That might sound simple to you. Well, it is pretty simple once you know about a few tools that can help you make it even simpler!</p>

    <p>Before we start programming the chat room, let's look at the finished product in action so you can understand what you'll build and what it will be like to use once you finish!</p>

    <aside>
      <p>If you're completely new to the web and to programming in general, then here is an exercise you can do on paper understand what we're doing.</p>
      <h2>Supplies:</h2>
      <ul>
        <li>Several sheets of paper and pen or pencil</li>
        <li>Two other friends. One will do, but it's better with two!</li>
      </ul>
      <h2>Steps:</h2>
      <ul>
          <li>Starting on one sheet of paper, write a heading at the top: <strong>Messages:</strong></li>
          <li>Decide who will be the first message writer.</li>
          <li>For the other two, close your eyes or stand somewhere where you cannot see what your friend is writing.</li>
          <li>First message writer: write down a short message on the line after the <strong>Messages:</strong> heading, then hand the paper and pen to one of your other friends.</li>
          <li>Take turns writing and passing the sheet to each other.</li>
      </ul>
      <h2>Questions:</h2>
      <ul>
        <li>Assuming you are a group of three, how would you communicate with the paper if two of you had to stay in different rooms, and only one of you could move from one room to the other at a time?</li>
        <li>What if you had ten other friends who you wanted to see your messages? How long would it take for each of them to see it using this paper process?</li>
        <li>What if you had a message that you wanted the whole world to see? How long do you think it would take if you had to hand deliver it to each person?</li>
        <li>What if you could send it in the mail?</li>
        <li>What else could you do to get it to more people faster?</li>
      </ul>
      <h1></h1>
    </p>
      <p>First, get a sheet of paper and a pencil or find a whiteboard and a marker.

    </aside>

  </body>
</html>